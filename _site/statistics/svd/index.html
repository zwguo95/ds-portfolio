<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Zhaowen Guo">
<meta name="dcterms.date" content="2024-03-17">
<title>Zhaowen Guo - The Power of Singular Vector Decomposition: A Beginner’s Guide</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../headshot_guo.jpg" rel="icon" type="image/jpeg">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-J1PPVYDT7J"></script><script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-J1PPVYDT7J', { 'anonymize_ip': true});
</script><script src="../../site_libs/kePrint-0.0.1/kePrint.js"></script><link href="../../site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>
</head>
<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="navbar navbar-expand-lg navbar-dark "><div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Zhaowen Guo</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
<li class="nav-item">
    <a class="nav-link" href="../../index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../statistics.html" rel="" target="">
 <span class="menu-text">Statistics</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../dataviz.html" rel="" target="">
 <span class="menu-text">Data Visualization</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-tutorials" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Tutorials</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-tutorials">
<li>
    <a class="dropdown-item" href="../../tutorials/word_embeddings.html" rel="" target="">
 <span class="dropdown-text">Word Embeddings with R</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../tutorials/data_visualization.html" rel="" target="">
 <span class="dropdown-text">Visualizing Data with R</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../tutorials/survey_data_visualization.html" rel="" target="">
 <span class="dropdown-text">Visualizing Survey Data with R</span></a>
  </li>  
    </ul>
</li>
</ul>
<ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item">
    <a class="nav-link" href="https://www.linkedin.com/in/zhaowen-guo-20535312a/" rel="" target=""><i class="bi bi-linkedin" role="img">
</i> 
 <span class="menu-text">LinkedIn</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://github.com/zwguo95" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text">GitHub</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="mailto:zwguo@uw.edu" rel="" target=""><i class="bi bi-envelope" role="img">
</i> 
 <span class="menu-text">Email</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-resume" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
      <i class="bi bi-file-earmark-person" role="img">
</i> 
 <span class="menu-text">Resume</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-resume">
<li>
    <a class="dropdown-item" href="../../resume/resume_guo.pdf" rel="" target="">
 <span class="dropdown-text">Resume</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../resume/cv_guo.pdf" rel="" target="">
 <span class="dropdown-text">CV</span></a>
  </li>  
    </ul>
</li>
</ul>
<div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav></header><!-- content --><header id="title-block-header" class="quarto-title-block default page-columns page-full"><div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">The Power of Singular Vector Decomposition: A Beginner’s Guide</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">code</div>
                <div class="quarto-category">machine learning</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p><a href="https://www.linkedin.com/in/zhaowen-guo-20535312a/">Zhaowen Guo</a> </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">March 17, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content"><p>SVD is not nearly as famous as it should be. — Gilbert Strang</p>
<p>SVD is a great 1-stop shop for data analysis. — Daniela Witten</p>
<section id="introduction" class="level2"><h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>Singular Vector Decomposition (SVD) is a matrix factorization technique that has become a cornerstone in the field of machine learning (ML). It not only allows for efficiently calculating the inverse of a matrix (if it exists) by multiplying the inverse of each decomposed simpler matrices, but also opens the door to a wide array of applications in ML and beyond.</p>
<p>In what follows, I will start by the definition and properties of SVD, and establish its connection with Principal Component Analysis (PCA). Then I will demonstrate different applications of SVD in ML, including but not limited to missing value imputation and latent feature extraction.</p>
<section id="definition-and-properties-of-svd" class="level3"><h3 class="anchored" data-anchor-id="definition-and-properties-of-svd">Definition and properties of SVD</h3>
<p>SVD decomposes a data matrix <span class="math inline">\(X_{m \times n}\)</span> into three matrices <span class="math inline">\(U_{m\times r}\)</span>, <span class="math inline">\(D_{r\times r}\)</span>, and <span class="math inline">\(V_{n\times r}\)</span>, regardless of the characteristics of the original matrix.</p>
<p><span class="math display">\[
X = UDV^T
\]</span> where</p>
<ul>
<li>U and V are orthogonal matrices (<span class="math inline">\(U^T U = I\)</span> and <span class="math inline">\(V^T V = I\)</span>), which are called <span style="text-decoration:underline">left singular vector</span>, and <span style="text-decoration:underline">right singular vector</span>, respectively</li>
<li>D is a diagonal matrix with non-negative and decreasing elements, which are called <span style="text-decoration:underline">singular values</span>
</li>
</ul>
<p>Let’s first check dimensions of the resulting matrices after applying SVD to a toy matrix X.</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Define a matrix</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">12</span><span class="op">)</span>,</span>
<span>            nrow <span class="op">=</span> <span class="fl">4</span>,</span>
<span>            ncol <span class="op">=</span> <span class="fl">3</span>,</span>
<span>            byrow <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Apply SVD</span></span>
<span><span class="va">svd_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/svd.html">svd</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Extract U, D, and V matrices</span></span>
<span><span class="va">U</span> <span class="op">&lt;-</span> <span class="va">svd_result</span><span class="op">$</span><span class="va">u</span></span>
<span><span class="va">D</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="va">svd_result</span><span class="op">$</span><span class="va">d</span><span class="op">)</span></span>
<span><span class="va">V</span> <span class="op">&lt;-</span> <span class="va">svd_result</span><span class="op">$</span><span class="va">v</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"The dimension for U matrix: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">U</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="st">" X "</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">U</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "The dimension for U matrix: 4 X 3"</code></pre>
</div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"The dimension for D matrix: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">D</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="st">" X "</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">D</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "The dimension for D matrix: 3 X 3"</code></pre>
</div>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"The dimension for V matrix: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">V</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="st">" X "</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">V</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "The dimension for V matrix: 3 X 3"</code></pre>
</div>
</div>
<p>We can then check matrix properties of SVD. As we can observe, matrices U and V are orthogonal, and matrix D is diagonal.</p>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Check properties of U and V (orthogonal matrix)</span></span>
<span><span class="va">is_orthogonal</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">A</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">A_T</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span></span>
<span>  <span class="va">dot_product_1</span> <span class="op">&lt;-</span> <span class="va">A</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">A_T</span></span>
<span>  <span class="va">dot_product_2</span> <span class="op">&lt;-</span> <span class="va">A_T</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">A</span></span>
<span>  <span class="va">identity_matrix_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">identity_matrix_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Logic.html">isTRUE</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html">all.equal</a></span><span class="op">(</span><span class="va">dot_product_1</span>, <span class="va">identity_matrix_1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/Logic.html">isTRUE</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html">all.equal</a></span><span class="op">(</span><span class="va">dot_product_2</span>, <span class="va">identity_matrix_2</span><span class="op">)</span><span class="op">)</span> <span class="co"># all.equal checks "nearly equal"</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">result</span><span class="op">&gt;=</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">is_orthogonal</span><span class="op">(</span><span class="va">U</span><span class="op">)</span> <span class="co"># TRUE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">is_orthogonal</span><span class="op">(</span><span class="va">V</span><span class="op">)</span> <span class="co"># TRUE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Check properties of D</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="va">D</span><span class="op">)</span> <span class="co"># diagonal values (or singular values in this case)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2.546241e+01 1.290662e+00 2.311734e-15</code></pre>
</div>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">D</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/row.html">row</a></span><span class="op">(</span><span class="va">D</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/col.html">col</a></span><span class="op">(</span><span class="va">D</span><span class="op">)</span><span class="op">]</span> <span class="co"># off-diagonal values are 0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0 0 0 0 0 0</code></pre>
</div>
</div>
</section><section id="connection-between-svd-and-pca" class="level3"><h3 class="anchored" data-anchor-id="connection-between-svd-and-pca">Connection between SVD and PCA</h3>
<p>Now, knowing that SVD can be used to approximate any matrix, it’s an opportune moment to revisit Principal Component Analysis (PCA), an unsupervised ML method that we might be more familiar with. As we will see, <span style="text-decoration:underline">SVD on a de-meaned (centered) data matrix is the same as PCA</span>.</p>
<p>Recall that PCA seeks to find principal components, or the direction in the feature space with maximum variance in the data.</p>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Center the data matrix (column means are 0)</span></span>
<span><span class="va">X_centered</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">X</span>, center <span class="op">=</span> <span class="cn">T</span>, scale <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colMeans</a></span><span class="op">(</span><span class="va">X_centered</span><span class="op">)</span> <span class="co"># check if centered</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0 0 0</code></pre>
</div>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Apply SVD to the centered data matrix</span></span>
<span><span class="va">svd_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/svd.html">svd</a></span><span class="op">(</span><span class="va">X_centered</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Apply PCA to the data</span></span>
<span><span class="va">pca_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/prcomp.html">prcomp</a></span><span class="op">(</span><span class="va">X</span>, scale. <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As we can see, columns of the right singular vector V correspond to principal components extracted from PCA, and SVD also yields less elapsed time than PCA. A key advantage of SVD is that it does not require a preliminary step of constructing a covariance as PCA does, providing greater computational efficiency in extracting principal components.</p>
<p>This efficiency becomes particularly prominent when handling</p>
<ul>
<li><p>High-dimensional datasets: when a data matrix possess too many features, the computational cost for constructing its covariance matrix can be huge</p></li>
<li><p>Full-rank data matrix: when the data matrix is full-rank, it often implies that many singular values will be non-negligible, and many principal components will be needed to reconstruct the original matrix</p></li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">svd_result</span><span class="op">$</span><span class="va">v</span><span class="op">)</span> <span class="co"># right singular vectors</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          [,1]       [,2]       [,3]
[1,] 0.5773503 -0.8164966  0.0000000
[2,] 0.5773503  0.4082483 -0.7071068
[3,] 0.5773503  0.4082483  0.7071068</code></pre>
</div>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">pca_result</span><span class="op">$</span><span class="va">rotation</span><span class="op">)</span> <span class="co"># principal components</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           PC1        PC2        PC3
[1,] 0.5773503 -0.8164966  0.0000000
[2,] 0.5773503  0.4082483 -0.7071068
[3,] 0.5773503  0.4082483  0.7071068</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Construct a high-dimensional and sparse data matrix</span></span>
<span><span class="va">n_rows</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span><span class="va">n_cols</span> <span class="op">&lt;-</span> <span class="fl">500</span></span>
<span></span>
<span><span class="va">sparse_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0</span>, nrow <span class="op">=</span> <span class="va">n_rows</span>, ncol <span class="op">=</span> <span class="va">n_cols</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Manually add some non-zero elements to mimic sparsity</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">non_zero_elements</span> <span class="op">&lt;-</span> <span class="fl">200</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">non_zero_elements</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">row_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">n_rows</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">col_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">n_cols</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">sparse_matrix</span><span class="op">[</span><span class="va">row_index</span>, <span class="va">col_index</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Compute every possible rank approximations</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">svd_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/svd.html">svd</a></span><span class="op">(</span><span class="va">sparse_matrix</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   user  system elapsed 
   0.19    0.00    0.58 </code></pre>
</div>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">pca_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/prcomp.html">prcomp</a></span><span class="op">(</span><span class="va">sparse_matrix</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   user  system elapsed 
   0.34    0.00    0.72 </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Compute top 10 rank approximations</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">svd_result</span> <span class="op">&lt;-</span> <span class="fu">irlba</span><span class="op">(</span><span class="va">sparse_matrix</span>, nv <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   user  system elapsed 
   0.02    0.00    0.03 </code></pre>
</div>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">pca_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/prcomp.html">prcomp</a></span><span class="op">(</span><span class="va">sparse_matrix</span>, rank. <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   user  system elapsed 
   0.39    0.00    0.61 </code></pre>
</div>
</div>
</section></section><section id="application-impute-missing-values" class="level2"><h2 class="anchored" data-anchor-id="application-impute-missing-values">Application: Impute Missing Values</h2>
<p>One popular application of SVD is to impute missing values. Without keeping all singular values and vectors, we can just retain the first d largest singular values to approximate the matrix A. The intuition is that the approximated matrix <span class="math inline">\(A_d\)</span> being a dense matrix that captures the primary structure and patterns in the original data.</p>
<p>This procedure is also called lower-rank approximation, which can be implemented in the following steps:</p>
<ul>
<li><p>Matrix approximation: fill in NAs with an initial guess (e.g.&nbsp;column means, zeros) and apply SVD with rank d, meaning that we only keep top d singular values and vectors</p></li>
<li><p>Missingness imputation: use the approximated matrix <span class="math inline">\(A_d\)</span> to fill in NAs in the original matrix</p></li>
</ul>
<p>Let’s use the following example for illustration:</p>
<p>We start by creating a toy data matrix A and call it our ground truth matrix. Then we manually add sparsity by replacing certain elements with NAs.</p>
<div class="cell">
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Create a toy dataset (sparse matrix)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">A</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span>, <span class="fl">25</span>, replace <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>, <span class="fl">5</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">ground_truth_matrix</span> <span class="op">&lt;-</span> <span class="va">A</span></span>
<span><span class="va">A</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">8</span>, <span class="fl">10</span>, <span class="fl">14</span>, <span class="fl">20</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">A</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     [,1] [,2] [,3] [,4] [,5]
[1,]    2    5    5    2   NA
[2,]   NA    2   NA    2    4
[3,]    2   NA    1   NA    2
[4,]    1    3   NA    3    1
[5,]    1   NA    4   NA    1</code></pre>
</div>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ground_truth_matrix</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     [,1] [,2] [,3] [,4] [,5]
[1,]    2    5    5    2   NA
[2,]    5    2   NA    2    4
[3,]    2    4    1   NA    2
[4,]    1    3    2    3    1
[5,]    1    5    4   NA    1</code></pre>
</div>
</div>
<p>Next, we apply SVD with varying d, which indicates the number of singular values/vectors.</p>
<div class="cell">
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Define svd</span></span>
<span><span class="va">impute_svd</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">matrix</span>, <span class="va">d</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># fill in missingness with column means</span></span>
<span>  <span class="va">column_means</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colMeans</a></span><span class="op">(</span><span class="va">matrix</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span>  <span class="va">matrix_filled</span> <span class="op">&lt;-</span> <span class="va">matrix</span></span>
<span>  <span class="va">na_indices</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">matrix</span><span class="op">)</span></span>
<span>  <span class="va">matrix_filled</span><span class="op">[</span><span class="va">na_indices</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">column_means</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/col.html">col</a></span><span class="op">(</span><span class="va">matrix</span><span class="op">)</span><span class="op">[</span><span class="va">na_indices</span><span class="op">]</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="co"># perform svd</span></span>
<span>  <span class="va">svd_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/svd.html">svd</a></span><span class="op">(</span><span class="va">matrix_filled</span><span class="op">)</span></span>
<span>  <span class="va">svd_res</span><span class="op">$</span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">svd_res</span><span class="op">$</span><span class="va">d</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">d</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">svd_res</span><span class="op">$</span><span class="va">d</span><span class="op">)</span> <span class="op">-</span> <span class="va">d</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># reconstruct the matrix</span></span>
<span>  <span class="va">approx_matrix</span> <span class="op">&lt;-</span> <span class="va">svd_res</span><span class="op">$</span><span class="va">u</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="va">svd_res</span><span class="op">$</span><span class="va">d</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">svd_res</span><span class="op">$</span><span class="va">v</span><span class="op">)</span></span>
<span>  <span class="va">imputed_vals</span> <span class="op">&lt;-</span> <span class="va">approx_matrix</span></span>
<span>  <span class="va">imputed_vals</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">matrix</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">imputed_vals</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can use the approximated matrix <span class="math inline">\(A_d\)</span> to reconstruct the original matrix and impute missing values. We can evaluate the performance of missingness imputation by mean squared error (MSE).</p>
<div class="cell">
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Construct the metric MSE</span></span>
<span><span class="va">mse</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">predicted</span>, <span class="va">truth</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">predicted</span> <span class="op">-</span> <span class="va">truth</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Display MSE for different d values (rank, or number of dimensions to define the reduced matrix)</span></span>
<span><span class="va">svd_errors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">d</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">imputed_values</span> <span class="op">&lt;-</span> <span class="fu">impute_svd</span><span class="op">(</span><span class="va">A</span>, <span class="va">d</span><span class="op">)</span></span>
<span>  <span class="va">svd_errors</span><span class="op">[</span><span class="va">d</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">mse</span><span class="op">(</span><span class="va">imputed_values</span>, <span class="va">ground_truth_matrix</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>How does SVD perform? As a baseline, consider a simple approach by replacing missing values with column means. It seems that rank-2 approximation is an optimal choice, which yields the lowest MSE. However, it’s important to note that it is not always the case that SVD approximation would outperform simple column mean imputation. We might need to consider other matrix decomposition techniques for missingness imputation, such as Non-negative Matrix Factorization (NMF), Alternating Least Squares (ALS), etc..</p>
<div class="cell">
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Create baseline imputation from column means</span></span>
<span><span class="va">na_indices</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span></span>
<span><span class="va">colmean_matrix</span> <span class="op">&lt;-</span> <span class="va">A</span></span>
<span><span class="va">colmean_matrix</span><span class="op">[</span><span class="va">na_indices</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colMeans</a></span><span class="op">(</span><span class="va">A</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/col.html">col</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span><span class="op">[</span><span class="va">na_indices</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">colmean_errors</span> <span class="op">&lt;-</span> <span class="fu">mse</span><span class="op">(</span><span class="va">colmean_matrix</span><span class="op">[</span><span class="va">na_indices</span><span class="op">]</span>, <span class="va">ground_truth_matrix</span><span class="op">[</span><span class="va">na_indices</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Report comparison of performance</span></span>
<span><span class="va">comparison</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span><span class="st">"Method"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Column Means"</span>, </span>
<span>                                  <span class="st">"Rank-1 Approximation"</span>,</span>
<span>                                  <span class="st">"Rank-2 Approximation"</span>,</span>
<span>                                  <span class="st">"Rank-3 Approximation"</span>,</span>
<span>                                  <span class="st">"Rank-4 Approximation"</span>,</span>
<span>                                  <span class="st">"Rank-5 Approximation"</span><span class="op">)</span>,</span>
<span>                     <span class="st">"MSE"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">colmean_errors</span>, <span class="va">svd_errors</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">comparison</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">kbl</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">kable_styling</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<thead><tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Method</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">MSE</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Column Means</td>
<td style="text-align: right;">4.312500</td>
</tr>
<tr class="even">
<td style="text-align: left;">Rank-1 Approximation</td>
<td style="text-align: right;">4.754839</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Rank-2 Approximation</td>
<td style="text-align: right;">4.094591</td>
</tr>
<tr class="even">
<td style="text-align: left;">Rank-3 Approximation</td>
<td style="text-align: right;">4.146353</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Rank-4 Approximation</td>
<td style="text-align: right;">4.319335</td>
</tr>
<tr class="even">
<td style="text-align: left;">Rank-5 Approximation</td>
<td style="text-align: right;">4.312500</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>In line with the idea of missingness imputation, SVD can also be leveraged to enhance recommendation systems! The goal is to predict unknown preferences or ratings of users for items (e.g.&nbsp;movies, products, or services) based on existing ratings. A notable example is <a href="https://en.wikipedia.org/wiki/Netflix_Prize#:~:text=On%20September%2021%2C%202009%2C%20the,for%20predicting%20ratings%20by%2010.06%25.">Netflix Prize competition</a>, where Netflix offered $1 million award to anyone who could improve the accuracy of its movie recommendation system by 10%. The <a href="https://www.asc.ohio-state.edu/statistics/dmsl/GrandPrize2009_BPC_BigChaos.pdf">winning team</a> just used SVD, along with techniques that incorporate other metadata, achieving a 10.06% improvement!</p>
</section><section id="application-topic-modeling" class="level2"><h2 class="anchored" data-anchor-id="application-topic-modeling">Application: Topic Modeling</h2>
<p>SVD is a powerful and generalizable technique that provides us another perspective on topic modeling. We begin by first transforming documents into a document-term matrix, where each row represents a document, each column reflects a term, and each cell denotes frequency. To refine this step further, we can also apply Term Frequency-Inverse Document Frequency <a href="https://en.wikipedia.org/wiki/Tf%E2%80%93idf">(TF-IDF)</a> to reweigh the cell values, adjusting for the uniqueness of each term for a given document.</p>
<p>SVD can then be perceived as decomposing a document-term matrix <span class="math inline">\(X_{m \times n}\)</span> into</p>
<ul>
<li><p><span class="math inline">\(U_{m \times r}\)</span>: document-topic matrix</p></li>
<li><p><span class="math inline">\(D_{r \times r}\)</span>: diagonal elements represent topic importance</p></li>
<li><p><span class="math inline">\(V_{n \times r}\)</span>: term-topic matrix</p></li>
</ul>
<p>For topic modeling, a crucial hyperparameter that requires tuning is the number of topics (often denoted by k). In the context of SVD, the idea is equivalent to selecting the top k singular values and their corresponding singular vectors in order to approximate the original data matrix.</p>
<div class="cell">
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Construct a document-term matrix</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/juliasilge/tidytext">tidytext</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tm.r-forge.r-project.org/">tm</a></span><span class="op">)</span></span>
<span><span class="va">documents</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span></span>
<span>  doc_id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">8</span>,</span>
<span>  text <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"The sky is blue and beautiful."</span>,</span>
<span>           <span class="st">"Love this blue and beautiful sky!"</span>,</span>
<span>           <span class="st">"The quick brown fox jumps over the lazy dog."</span>,</span>
<span>           <span class="st">"A king's breakfast has sausages, ham, bacon, eggs, toast, and beans"</span>,</span>
<span>           <span class="st">"I love green eggs, ham, sausages, and bacon!"</span>,</span>
<span>           <span class="st">"The brown fox is quick and the blue dog is lazy!"</span>,</span>
<span>           <span class="st">"The sky is very blue and the sky is very beautiful today"</span>,</span>
<span>           <span class="st">"The dog is lazy but the brown fox is quick!"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">tidy_documents</span> <span class="op">&lt;-</span> <span class="va">documents</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tidytext/man/unnest_tokens.html">unnest_tokens</a></span><span class="op">(</span><span class="va">word</span>, <span class="va">text</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">anti_join</span><span class="op">(</span><span class="va">stop_words</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dtm</span> <span class="op">&lt;-</span> <span class="va">tidy_documents</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">count</span><span class="op">(</span><span class="va">doc_id</span>, <span class="va">word</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tidytext/man/document_term_casters.html">cast_dtm</a></span><span class="op">(</span><span class="va">doc_id</span>, <span class="va">word</span>, <span class="va">n</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Apply SVD and examine each decomposed matrix</span></span>
<span><span class="va">svd_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/svd.html">svd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">dtm</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">k</span> <span class="op">&lt;-</span> <span class="fl">2</span> <span class="co"># choose k=2 for simplicity</span></span>
<span><span class="va">Uk</span> <span class="op">&lt;-</span> <span class="va">svd_result</span><span class="op">$</span><span class="va">u</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="va">k</span><span class="op">]</span></span>
<span><span class="va">Dk</span> <span class="op">&lt;-</span> <span class="va">svd_result</span><span class="op">$</span><span class="va">d</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">k</span><span class="op">]</span></span>
<span><span class="va">Vk</span> <span class="op">&lt;-</span> <span class="va">svd_result</span><span class="op">$</span><span class="va">v</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="va">k</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As we can see, the decomposed <span class="math inline">\(U_k\)</span> matrix captures documents by topics.</p>
<div class="cell">
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">Us</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span>`Document ID` <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">8</span>,</span>
<span>             `Topic 1` <span class="op">=</span> <span class="va">Uk</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>,</span>
<span>             `Topic 2` <span class="op">=</span> <span class="va">Uk</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">Us</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">kbl</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">kable_styling</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<thead><tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">Document ID</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Topic 1</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Topic 2</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.1294362</td>
<td style="text-align: right;">0.4303175</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: right;">-0.1392703</td>
<td style="text-align: right;">0.4926330</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3</td>
<td style="text-align: right;">-0.5597761</td>
<td style="text-align: right;">-0.1933906</td>
</tr>
<tr class="even">
<td style="text-align: right;">4</td>
<td style="text-align: right;">-0.0088357</td>
<td style="text-align: right;">0.2551944</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5</td>
<td style="text-align: right;">-0.0175544</td>
<td style="text-align: right;">0.2534139</td>
</tr>
<tr class="even">
<td style="text-align: right;">6</td>
<td style="text-align: right;">-0.5889438</td>
<td style="text-align: right;">-0.0537521</td>
</tr>
<tr class="odd">
<td style="text-align: right;">7</td>
<td style="text-align: right;">-0.1672636</td>
<td style="text-align: right;">0.6091753</td>
</tr>
<tr class="even">
<td style="text-align: right;">8</td>
<td style="text-align: right;">-0.5246738</td>
<td style="text-align: right;">-0.1772371</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The singular values are stored in the following matrix <span class="math inline">\(D_k\)</span>, which correspond to how important each topic is.</p>
<div class="cell">
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">D_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="va">Dk</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">D_matrix</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Topic 1"</span>, <span class="st">"Topic 2"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">D_matrix</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Topic 1"</span>, <span class="st">"Topic 2"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">D_matrix</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">kbl</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">kable_styling</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<thead><tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Topic 1</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Topic 2</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Topic 1</td>
<td style="text-align: right;">3.993368</td>
<td style="text-align: right;">0.000000</td>
</tr>
<tr class="even">
<td style="text-align: left;">Topic 2</td>
<td style="text-align: right;">0.000000</td>
<td style="text-align: right;">3.460071</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The <span class="math inline">\(V_k\)</span> matrix represents terms by topics.</p>
<div class="cell">
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">terms</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">dtm</span><span class="op">)</span></span>
<span><span class="va">V_matrix</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span>`Term` <span class="op">=</span> <span class="va">terms</span>,</span>
<span>                   `Topic 1` <span class="op">=</span> <span class="va">Vk</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>,</span>
<span>                   `Topic 2` <span class="op">=</span> <span class="va">Vk</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">V_matrix</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">kbl</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">kable_styling</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<thead><tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Term</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Topic 1</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Topic 2</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">beautiful</td>
<td style="text-align: right;">-0.1091735</td>
<td style="text-align: right;">0.4428019</td>
</tr>
<tr class="even">
<td style="text-align: left;">blue</td>
<td style="text-align: right;">-0.2566540</td>
<td style="text-align: right;">0.4272669</td>
</tr>
<tr class="odd">
<td style="text-align: left;">sky</td>
<td style="text-align: right;">-0.1510589</td>
<td style="text-align: right;">0.6188605</td>
</tr>
<tr class="even">
<td style="text-align: left;">love</td>
<td style="text-align: right;">-0.0392713</td>
<td style="text-align: right;">0.2156161</td>
</tr>
<tr class="odd">
<td style="text-align: left;">brown</td>
<td style="text-align: right;">-0.4190432</td>
<td style="text-align: right;">-0.1226506</td>
</tr>
<tr class="even">
<td style="text-align: left;">dog</td>
<td style="text-align: right;">-0.4190432</td>
<td style="text-align: right;">-0.1226506</td>
</tr>
<tr class="odd">
<td style="text-align: left;">fox</td>
<td style="text-align: right;">-0.4190432</td>
<td style="text-align: right;">-0.1226506</td>
</tr>
<tr class="even">
<td style="text-align: left;">jumps</td>
<td style="text-align: right;">-0.1401764</td>
<td style="text-align: right;">-0.0558921</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lazy</td>
<td style="text-align: right;">-0.4190432</td>
<td style="text-align: right;">-0.1226506</td>
</tr>
<tr class="even">
<td style="text-align: left;">quick</td>
<td style="text-align: right;">-0.4190432</td>
<td style="text-align: right;">-0.1226506</td>
</tr>
<tr class="odd">
<td style="text-align: left;">bacon</td>
<td style="text-align: right;">-0.0066085</td>
<td style="text-align: right;">0.1469936</td>
</tr>
<tr class="even">
<td style="text-align: left;">beans</td>
<td style="text-align: right;">-0.0022126</td>
<td style="text-align: right;">0.0737541</td>
</tr>
<tr class="odd">
<td style="text-align: left;">breakfast</td>
<td style="text-align: right;">-0.0022126</td>
<td style="text-align: right;">0.0737541</td>
</tr>
<tr class="even">
<td style="text-align: left;">eggs</td>
<td style="text-align: right;">-0.0066085</td>
<td style="text-align: right;">0.1469936</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ham</td>
<td style="text-align: right;">-0.0066085</td>
<td style="text-align: right;">0.1469936</td>
</tr>
<tr class="even">
<td style="text-align: left;">king's</td>
<td style="text-align: right;">-0.0022126</td>
<td style="text-align: right;">0.0737541</td>
</tr>
<tr class="odd">
<td style="text-align: left;">sausages</td>
<td style="text-align: right;">-0.0066085</td>
<td style="text-align: right;">0.1469936</td>
</tr>
<tr class="even">
<td style="text-align: left;">toast</td>
<td style="text-align: right;">-0.0022126</td>
<td style="text-align: right;">0.0737541</td>
</tr>
<tr class="odd">
<td style="text-align: left;">green</td>
<td style="text-align: right;">-0.0043959</td>
<td style="text-align: right;">0.0732395</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Now, we can examine top 5 terms associated with each topic.</p>
<div class="cell">
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">top_terms</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">Vk</span>, <span class="fl">2</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">terms</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">top_terms</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     [,1]    [,2]       
[1,] "brown" "sky"      
[2,] "dog"   "beautiful"
[3,] "fox"   "blue"     
[4,] "lazy"  "love"     
[5,] "quick" "bacon"    </code></pre>
</div>
</div>
<p>Beyond what has been discussed, some other cool applications of SVD in NLP include: information retrieval via <a href="https://link.springer.com/chapter/10.1007/978-981-99-3243-6_45">Latent Semantic Analysis</a> and word co-occurrence detection in <a href="https://smltar.com/embeddings.html">word embeddings</a> and other downstream tasks (e.g.&nbsp;<a href="https://ideas.repec.org/p/sek/iacpro/0702094.html">text classification</a>). Feel free to explore!</p>
<p><strong>References and additional resources:</strong></p>
<ul>
<li><p>A wonderful twitter <a href="https://twitter.com/WomenInStat/status/1285612667839885312">thread</a> on SVD by Daniela Witten (a nice summary can be found <a href="https://www.govindgnair.com/post/svd-is-almost-all-you-need/">here</a>)</p></li>
<li><p>A cool geometric <a href="https://www.youtube.com/watch?v=vSczTbgc8Rc">interpretation</a> of SVD</p></li>
<li><p>A nice <a href="https://www.youtube.com/watch?v=lRZ4aMaXPBI&amp;list=PLtmWHNX-gukKocXQOkQjuVxglSDYWsSh9&amp;index=3">tutorial</a> illustrating the connection between SVD and topic modeling using Python</p></li>
</ul>


</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>