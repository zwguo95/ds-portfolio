<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Zhaowen Guo">
<meta name="dcterms.date" content="2025-02-24">
<title>Zhaowen Guo - Sequential Testing and Early Stopping</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../headshot_guo.jpg" rel="icon" type="image/jpeg">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-J1PPVYDT7J"></script><script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-J1PPVYDT7J', { 'anonymize_ip': true});
</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>
</head>
<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="navbar navbar-expand-lg navbar-dark "><div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Zhaowen Guo</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
<li class="nav-item">
    <a class="nav-link" href="../../index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../statistics.html" rel="" target="">
 <span class="menu-text">Statistics</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../dataviz.html" rel="" target="">
 <span class="menu-text">Data Visualization</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-tutorials" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Tutorials</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-tutorials">
<li>
    <a class="dropdown-item" href="../../tutorials/word_embeddings.html" rel="" target="">
 <span class="dropdown-text">Word Embeddings with R</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../tutorials/survey_data_visualization.html" rel="" target="">
 <span class="dropdown-text">Visualizing Survey Data with R</span></a>
  </li>  
    </ul>
</li>
</ul>
<ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item">
    <a class="nav-link" href="https://www.linkedin.com/in/zhaowen-guo-20535312a/" rel="" target=""><i class="bi bi-linkedin" role="img">
</i> 
 <span class="menu-text">LinkedIn</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://github.com/zwguo95" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text">GitHub</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="mailto:zg234@georgetown.edu" rel="" target=""><i class="bi bi-envelope" role="img">
</i> 
 <span class="menu-text">Email</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-resume" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
      <i class="bi bi-file-earmark-person" role="img">
</i> 
 <span class="menu-text">Resume</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-resume">
<li>
    <a class="dropdown-item" href="../../resume/resume_guo.pdf" rel="" target="">
 <span class="dropdown-text">Resume</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../resume/cv_guo.pdf" rel="" target="">
 <span class="dropdown-text">CV</span></a>
  </li>  
    </ul>
</li>
</ul>
<div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav></header><!-- content --><header id="title-block-header" class="quarto-title-block default page-columns page-full"><div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Sequential Testing and Early Stopping</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">code</div>
                <div class="quarto-category">statistics</div>
                <div class="quarto-category">experimental design</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p><a href="https://www.linkedin.com/in/zhaowen-guo-20535312a/">Zhaowen Guo</a> </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">February 24, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content"><p>A/B testing is a cornerstone of data-driven decision-making, allowing business to evaluate new features and optimize user experiences. Whether it’s tweaking a website’s layout, or testing new content recommendations, A/B testing provides insightful feedback on what works and what doesn’t.</p>
<p>Conventionally, A/B tests follow a <strong><em>fixed sample size approach</em></strong>—running until a set number of users have been exposed before analyzing results. However, waiting for the full sample can be inefficient and costly in many real-world scenarios.</p>
<p>For example, if a new recommendation algorithm significantly boosts engagement, delaying its rollout until the test is complete means lost revenue and user satisfaction. In contrast, if an update unintentionally promotes harmful content, running the test to completion could expose more users to harm before corrective action is taken.</p>
<p>This is where sequential testing and early stopping come in. Instead of waiting for the full sample, this allows continuous monitoring of test results. Experiments can stop early when there’s <strong><em>enough</em></strong> evidence to confirm a winner—or to prevent harm.</p>
<section id="peeking-problem" class="level1"><h1>Peeking Problem</h1>
<p>The question then becomes: what counts as “enough” evidence?</p>
<p>If we repeatedly apply fixed-sample-size tests (e.g.&nbsp;t-tests, Kolmogorov-Smirnov test, Mann-Whitney tests) at multiple points until significance is reached, we increase the likelihood of false positives—a phenomenon known as the peeking problem.</p>
<p>To illustrate, suppose we set our significance level at <span class="math inline">\(\alpha=0.05\)</span>, meaning there’s a 5% chance of detecting a significant effect when no effect exists. If we check results once at the end of the test, this error rate holds. However, if we peek multiple times (<span class="math inline">\(k\)</span> peeks), the probability of making at least one false positive error grows exponentially, following:</p>
<p><span class="math display">\[
\alpha_{\text{inflated}} = 1 - (1 - \alpha)^k
\]</span></p>
<p>This becomes even clearer with a simulation. Assuming no real difference between treatment and control, I generated 1000 observations per group and run 100 simulations. At regular checkpoints every 10 observations, I applied t-tests, Mann-Whitney tests, and Kolmogorov-Smirnov tests, recording how often their p-values fall below <span class="math inline">\(\alpha=0.05\)</span>.</p>
<p>In the plot below, red lines represent paths of simulated p-values, while black dots indicate points where significance was falsely detected. Y axis is log-transformed to those black dots to be seen. Across all three tests, the false positive rates are highly inflated—30% for t-tests, 32% for Mann-Whitney tests, and 26% for Kolmogorov-Smirnov tests—far exceeding the 5% threshold.</p>
<p><img src="peeking_illustration.png" class="img-fluid"></p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Simulation parameters</span></span>
<span><span class="va">n_simulations</span> <span class="op">&lt;-</span> <span class="fl">100</span>      </span>
<span><span class="va">n_observations</span> <span class="op">&lt;-</span> <span class="fl">1000</span>    </span>
<span><span class="va">alpha</span> <span class="op">&lt;-</span> <span class="fl">0.05</span></span>
<span><span class="va">checkpoints</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">10</span>, <span class="va">n_observations</span>, by<span class="op">=</span><span class="fl">10</span><span class="op">)</span>  </span>
<span></span>
<span><span class="co"># Store p-values</span></span>
<span><span class="va">p_values_t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow<span class="op">=</span><span class="va">n_simulations</span>, ncol<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">checkpoints</span><span class="op">)</span><span class="op">)</span>  </span>
<span><span class="va">p_values_mw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow<span class="op">=</span><span class="va">n_simulations</span>, ncol<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">checkpoints</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="va">p_values_ks</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow<span class="op">=</span><span class="va">n_simulations</span>, ncol<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">checkpoints</span><span class="op">)</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">false_positive_count_t</span> <span class="op">&lt;-</span> <span class="fl">0</span>   </span>
<span><span class="va">false_positive_count_mw</span> <span class="op">&lt;-</span> <span class="fl">0</span>  </span>
<span><span class="va">false_positive_count_ks</span> <span class="op">&lt;-</span> <span class="fl">0</span>  </span>
<span></span>
<span><span class="co"># Run A/A test simulations</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">sim</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_simulations</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="va">control</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n_observations</span>, mean<span class="op">=</span><span class="fl">0</span>, sd<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">treatment</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n_observations</span>, mean<span class="op">=</span><span class="fl">0</span>, sd<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">checkpoints</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">n</span> <span class="op">&lt;-</span> <span class="va">checkpoints</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>    </span>
<span>    <span class="va">p_values_t</span><span class="op">[</span><span class="va">sim</span>, <span class="va">i</span><span class="op">]</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/t.test.html">t.test</a></span><span class="op">(</span><span class="va">control</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">]</span>, <span class="va">treatment</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">]</span><span class="op">)</span><span class="op">$</span><span class="va">p.value</span></span>
<span>    <span class="va">p_values_mw</span><span class="op">[</span><span class="va">sim</span>, <span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/wilcox.test.html">wilcox.test</a></span><span class="op">(</span><span class="va">control</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">]</span>, <span class="va">treatment</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">]</span><span class="op">)</span><span class="op">$</span><span class="va">p.value</span></span>
<span>    <span class="va">p_values_ks</span><span class="op">[</span><span class="va">sim</span>, <span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/ks.test.html">ks.test</a></span><span class="op">(</span><span class="va">control</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">]</span>, <span class="va">treatment</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">]</span><span class="op">)</span><span class="op">$</span><span class="va">p.value</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="va">p_values_t</span><span class="op">[</span><span class="va">sim</span>, <span class="op">]</span> <span class="op">&lt;</span> <span class="va">alpha</span><span class="op">)</span><span class="op">)</span> <span class="va">false_positive_count_t</span> <span class="op">&lt;-</span> <span class="va">false_positive_count_t</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="va">p_values_mw</span><span class="op">[</span><span class="va">sim</span>, <span class="op">]</span> <span class="op">&lt;</span> <span class="va">alpha</span><span class="op">)</span><span class="op">)</span> <span class="va">false_positive_count_mw</span> <span class="op">&lt;-</span> <span class="va">false_positive_count_mw</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="va">p_values_ks</span><span class="op">[</span><span class="va">sim</span>, <span class="op">]</span> <span class="op">&lt;</span> <span class="va">alpha</span><span class="op">)</span><span class="op">)</span> <span class="va">false_positive_count_ks</span> <span class="op">&lt;-</span> <span class="va">false_positive_count_ks</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Compute false positive rates</span></span>
<span><span class="va">false_positive_rate_t</span> <span class="op">&lt;-</span> <span class="va">false_positive_count_t</span> <span class="op">/</span> <span class="va">n_simulations</span></span>
<span><span class="va">false_positive_rate_mw</span> <span class="op">&lt;-</span> <span class="va">false_positive_count_mw</span> <span class="op">/</span> <span class="va">n_simulations</span></span>
<span><span class="va">false_positive_rate_ks</span> <span class="op">&lt;-</span> <span class="va">false_positive_count_ks</span> <span class="op">/</span> <span class="va">n_simulations</span></span>
<span></span>
<span><span class="co"># Convert to long format for visualization</span></span>
<span><span class="va">df_t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">p_values_t</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">df_t</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">checkpoints</span></span>
<span><span class="va">df_t</span><span class="op">$</span><span class="va">Simulation</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_simulations</span></span>
<span><span class="va">df_long_t</span> <span class="op">&lt;-</span> <span class="va">df_t</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="op">-</span><span class="va">Simulation</span>, names_to <span class="op">=</span> <span class="st">"Sample_Size"</span>, values_to <span class="op">=</span> <span class="st">"P_Value"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Sample_Size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">Sample_Size</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot the peeking problem</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">df_long_t</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Sample_Size</span>, y<span class="op">=</span><span class="va">P_Value</span>, group<span class="op">=</span><span class="va">Simulation</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>color<span class="op">=</span><span class="st">"red"</span>, alpha<span class="op">=</span><span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df_long_t</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">P_Value</span> <span class="op">&lt;</span> <span class="fl">0.05</span><span class="op">)</span>, </span>
<span>             <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Sample_Size</span>, y<span class="op">=</span><span class="va">P_Value</span><span class="op">)</span>, color<span class="op">=</span><span class="st">"black"</span>, size<span class="op">=</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span>yintercept<span class="op">=</span><span class="fl">0.05</span>, linetype<span class="op">=</span><span class="st">"dashed"</span>, color<span class="op">=</span><span class="st">"black"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_log10</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">"Illustration of the Peeking Problem"</span>,</span>
<span>       x<span class="op">=</span><span class="st">"Sample Size"</span>,</span>
<span>       y<span class="op">=</span><span class="st">"p-value"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html">ggsave</a></span><span class="op">(</span><span class="st">"peeking_illustration.png"</span>, width <span class="op">=</span> <span class="fl">7</span>, height <span class="op">=</span> <span class="fl">6</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="sequential-testing" class="level1"><h1>Sequential Testing</h1>
<p>How do sequential testing methods reduce false positive rates while allowing early stopping when evidence is strong? This table below provides a non-exhaustive overview of different sequential testing approaches, focusing on how they determine when evidence is sufficient to stop, and how they mitigate Type I error in the meantime.</p>
<table class="table">
<colgroup>
<col style="width: 24%">
<col style="width: 24%">
<col style="width: 24%">
<col style="width: 26%">
</colgroup>
<thead><tr class="header">
<th>Method</th>
<th>Example</th>
<th>Stopping Criterion</th>
<th>Control Type I Error</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Likelihood Ratio-Based Methods</td>
<td>Wald’s Sequential Probability Ratio Test (SPRT), 2-SPRT, Sequential Triangular Test</td>
<td>Compare likelihood ratios of <span class="math inline">\(H_0\)</span> vs.&nbsp;<span class="math inline">\(H_1\)</span> and stop when it crosses a predefined threshold</td>
<td>Set decision boundaries (A, B) for likelihood ratios</td>
</tr>
<tr class="even">
<td>Group Sequential Testing</td>
<td>Alpha Spending Functions (Pocock Test, O’Brien-Fleming Test, Lan-DeMets)</td>
<td>Preplanned interim analyses adjust <span class="math inline">\(\alpha\)</span> and stop when a checkpoint reaches significance</td>
<td>Preallocate <span class="math inline">\(\alpha\)</span> over checkpoints (e.g.&nbsp;constant <span class="math inline">\(\alpha\)</span>, from conservative to liberal, dynamic adjustment based on observed data)</td>
</tr>
<tr class="odd">
<td>Distribution-Based Testing</td>
<td>Confidence Sequences (Sequential P-Values) for Continuous or Count Data</td>
<td>Monitor distributional changes and stop when distribution-difference bands exclude zero</td>
<td>Construct confidence consequences that shrink dynamically, ensuring anytime-valid inference without alpha-spending</td>
</tr>
</tbody>
</table>
<p>Likelihood ratio-based and group sequential testing methods rely on classical statistical tests that compare means or proportions over time. They control false positive error rates by predefining when to analyze the data—either by setting decision boundaries or by adjusting significance levels (<span class="math inline">\(\alpha\)</span> ) at interim checkpoints. However, both approaches require assumptions about the underlying data distribution and a predefined schedule for checkpoints.</p>
<p>In contrast, distribution-based testing tracks entire distributions rather than just summary statistics like means or proportions. This approach is more generalizable without depending on assumptions about finite moments—an issue for mean-based tests when applied to heavy-tailed distributions like the Cauchy. Additionally, distribution-based methods allow for continuous monitoring without the need for preplanned interim analyses or alpha-spending adjustments, making them particularly effective for real-time decision making.</p>
<section id="illustration-of-early-stopping" class="level2"><h2 class="anchored" data-anchor-id="illustration-of-early-stopping">Illustration of Early Stopping</h2>
<p>To demonstration how sequential testing methods enable early stopping, I conducted a simulation reflecting a common A/B testing scenario: user click behavior. The goal is to compare sequential testing approaches—Group Sequential Testing (GST) and Distribution-Based Testing using sequential p-values—against a fixed sample size approach determined via traditional power analysis.</p>
<p>I consider a simple two-arm experiment where users are randomly assigned to either a control or treatment group. The treatment effect is assumed to increase the probability of a user clicking by 5 percentage points—from 30% in control to 35% in treatment.</p>
<p>Here’s how each sequential testing method works:</p>
<ul>
<li>
<p>Group Sequential Testing (GST)</p>
<ul>
<li>I assume 10 interim peeks and apply Pocock’s alpha spending function, which equally distributes the total significance level (α=0.05) across all peeks. The test stops at the first interim check where the treatment effect reaches significance.</li>
</ul>
</li>
<li>
<p>Distribution-Based Testing</p>
<ul>
<li>Click rates are monitored continuously at every observation, without predefined checkpoints or alpha spending. The test stops as soon as the Dirichlet sequential p-value falls below <span class="math inline">\(\alpha = 0.05\)</span>
</li>
</ul>
</li>
</ul>
<p>As shown in the graph below, both sequential testing methods stopped early, requiring fewer samples to detect the effect compared to a fixed-sample approach with no interim analysis.</p>
<p><img src="illustration_early_stopping.png" class="img-fluid"></p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/heliosdrm/pwr">pwr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define clicking probabilities</span></span>
<span><span class="va">pA</span> <span class="op">&lt;-</span> <span class="fl">0.30</span> </span>
<span><span class="va">pB</span> <span class="op">&lt;-</span> <span class="fl">0.35</span></span>
<span></span>
<span><span class="co"># Cohen's h for difference in two proportions</span></span>
<span><span class="va">cohen_h</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">p1</span>, <span class="va">p2</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fl">2</span> <span class="op">*</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Trig.html">asin</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">p1</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html">asin</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">p2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">effect_size_h</span> <span class="op">&lt;-</span> <span class="fu">cohen_h</span><span class="op">(</span><span class="va">pA</span>, <span class="va">pB</span><span class="op">)</span></span>
<span><span class="va">effect_size_h</span></span>
<span></span>
<span><span class="co"># Compute required sample size</span></span>
<span><span class="va">power_calc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/pwr/man/pwr.2p.test.html">pwr.2p.test</a></span><span class="op">(</span>h <span class="op">=</span> <span class="va">effect_size_h</span>,</span>
<span>                          sig.level <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>                          power <span class="op">=</span> <span class="fl">0.8</span>,</span>
<span>                          alternative <span class="op">=</span> <span class="st">"two.sided"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">power_calc</span> <span class="co"># ~1376 required per group</span></span>
<span></span>
<span><span class="co"># Generate synthetic click data with cumulative counts per arm</span></span>
<span><span class="va">generate_click_data</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">max_n</span>, <span class="va">pA</span>, <span class="va">pB</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">A_raw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">max_n</span>, size <span class="op">=</span> <span class="fl">1</span>, prob <span class="op">=</span> <span class="va">pA</span><span class="op">)</span> </span>
<span>  <span class="va">B_raw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">max_n</span>, size <span class="op">=</span> <span class="fl">1</span>, prob <span class="op">=</span> <span class="va">pB</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>    A_clicks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cumsum</a></span><span class="op">(</span><span class="va">A_raw</span><span class="op">)</span>,</span>
<span>    B_clicks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cumsum</a></span><span class="op">(</span><span class="va">B_raw</span><span class="op">)</span>,</span>
<span>    Sample_Size <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">max_n</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Group sequential test with Pocock function</span></span>
<span><span class="va">gst_test</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">counts</span>, <span class="va">check_index</span>, <span class="va">total_checks</span>, <span class="va">alpha</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">alpha_check</span> <span class="op">&lt;-</span> <span class="va">alpha</span> <span class="op">/</span> <span class="va">total_checks</span></span>
<span>  <span class="va">total</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">counts</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">total</span> <span class="op">&lt;</span> <span class="fl">2</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># 2-proportion z-test</span></span>
<span>  <span class="va">pA</span> <span class="op">&lt;-</span> <span class="va">counts</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">/</span> <span class="va">total</span></span>
<span>  <span class="va">pB</span> <span class="op">&lt;-</span> <span class="va">counts</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">/</span> <span class="va">total</span></span>
<span>  <span class="va">p_hat</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">counts</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="va">counts</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">total</span><span class="op">)</span></span>
<span>  <span class="va">se</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">p_hat</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">p_hat</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="va">counts</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span> <span class="op">/</span> <span class="va">counts</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">se</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">z_stat</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">pA</span> <span class="op">-</span> <span class="va">pB</span><span class="op">)</span> <span class="op">/</span> <span class="va">se</span></span>
<span>  <span class="va">p_val</span> <span class="op">&lt;-</span> <span class="fl">2</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">pnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">z_stat</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">p_val</span> <span class="op">&lt;</span> <span class="va">alpha_check</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Distribution-based sequential p-values, adapted from https://gist.github.com/michaellindon/5ce04c744d20755c3f653fbb58c2f4dd</span></span>
<span><span class="va">sequential_p_value</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">counts</span>, <span class="va">assignment_probabilities</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>                              <span class="va">dirichlet_alpha</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">alpha</span> <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">counts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">counts</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">dirichlet_alpha</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">dirichlet_alpha</span> <span class="op">&lt;-</span> <span class="fl">100</span> <span class="op">*</span> <span class="va">assignment_probabilities</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">total_counts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">counts</span><span class="op">)</span></span>
<span>  <span class="va">alpha_sum</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">dirichlet_alpha</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">lm1</span> <span class="op">&lt;-</span> <span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Special.html">lgamma</a></span><span class="op">(</span><span class="va">total_counts</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span> <span class="op">-</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Special.html">lgamma</a></span><span class="op">(</span><span class="va">counts</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/Special.html">lgamma</a></span><span class="op">(</span><span class="va">alpha_sum</span><span class="op">)</span> <span class="op">-</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Special.html">lgamma</a></span><span class="op">(</span><span class="va">dirichlet_alpha</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Special.html">lgamma</a></span><span class="op">(</span><span class="va">dirichlet_alpha</span> <span class="op">+</span> <span class="va">counts</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/Special.html">lgamma</a></span><span class="op">(</span><span class="va">alpha_sum</span> <span class="op">+</span> <span class="va">total_counts</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">lm0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Special.html">lgamma</a></span><span class="op">(</span><span class="va">total_counts</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">counts</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">assignment_probabilities</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Special.html">lgamma</a></span><span class="op">(</span><span class="va">counts</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">pval</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">lm0</span> <span class="op">-</span> <span class="va">lm1</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">pval</span><span class="op">)</span> <span class="op">&lt;</span> <span class="va">alpha</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">simulate_early_stopping</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">max_n</span>, <span class="va">alpha</span>, <span class="va">pA</span>, <span class="va">pB</span>, <span class="va">num_gst_peeks</span> <span class="op">=</span> <span class="fl">10</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">generate_click_data</span><span class="op">(</span><span class="va">max_n</span>, <span class="va">pA</span>, <span class="va">pB</span><span class="op">)</span></span>
<span>  <span class="va">peeking_points</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">ceiling</a></span><span class="op">(</span><span class="va">max_n</span> <span class="op">/</span> <span class="va">num_gst_peeks</span><span class="op">)</span>, <span class="va">max_n</span>, length.out <span class="op">=</span> <span class="va">num_gst_peeks</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">gst_stop</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span>  <span class="va">dirichlet_stop</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span>  </span>
<span>  <span class="va">effect_est</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="va">max_n</span><span class="op">)</span></span>
<span>  <span class="va">ci_lower</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="va">max_n</span><span class="op">)</span></span>
<span>  <span class="va">ci_upper</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="va">max_n</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="va">max_n</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">counts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">A_clicks</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="va">df</span><span class="op">$</span><span class="va">B_clicks</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">effect_est</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="op">(</span><span class="va">counts</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">counts</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">se</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="va">counts</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="va">counts</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">ci_lower</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">effect_est</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1.96</span> <span class="op">*</span> <span class="va">se</span></span>
<span>    <span class="va">ci_upper</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">effect_est</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1.96</span> <span class="op">*</span> <span class="va">se</span></span>
<span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">i</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">peeking_points</span> <span class="op">&amp;&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">gst_stop</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">peeking_points</span> <span class="op">==</span> <span class="va">i</span><span class="op">)</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="fu">gst_test</span><span class="op">(</span><span class="va">counts</span>, <span class="va">idx</span>, <span class="va">num_gst_peeks</span>, <span class="va">alpha</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">gst_stop</span> <span class="op">&lt;-</span> <span class="va">i</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">dirichlet_stop</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="fu">sequential_p_value</span><span class="op">(</span><span class="va">counts</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">0.5</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="va">alpha</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">dirichlet_stop</span> <span class="op">&lt;-</span> <span class="va">i</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">gst_stop</span><span class="op">)</span><span class="op">)</span> <span class="va">gst_stop</span> <span class="op">&lt;-</span> <span class="va">max_n</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">dirichlet_stop</span><span class="op">)</span><span class="op">)</span> <span class="va">dirichlet_stop</span> <span class="op">&lt;-</span> <span class="va">max_n</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>    df <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>      Sample_Size <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">max_n</span>,</span>
<span>      Effect_Est <span class="op">=</span> <span class="va">effect_est</span>,</span>
<span>      CI_Lower <span class="op">=</span> <span class="va">ci_lower</span>,</span>
<span>      CI_Upper <span class="op">=</span> <span class="va">ci_upper</span></span>
<span>    <span class="op">)</span>,</span>
<span>    gst_stop <span class="op">=</span> <span class="va">gst_stop</span>,</span>
<span>    dirichlet_stop <span class="op">=</span> <span class="va">dirichlet_stop</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu">simulate_early_stopping</span><span class="op">(</span></span>
<span>  max_n <span class="op">=</span> <span class="fl">2000</span>,</span>
<span>  alpha <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>  pA <span class="op">=</span> <span class="fl">0.30</span>,</span>
<span>  pB <span class="op">=</span> <span class="fl">0.35</span>,</span>
<span>  num_gst_peeks <span class="op">=</span> <span class="fl">10</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="va">results</span><span class="op">$</span><span class="va">df</span></span>
<span><span class="va">gst_stop</span> <span class="op">&lt;-</span> <span class="va">results</span><span class="op">$</span><span class="va">gst_stop</span></span>
<span><span class="va">dirichlet_stop</span> <span class="op">&lt;-</span> <span class="va">results</span><span class="op">$</span><span class="va">dirichlet_stop</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Sample_Size</span>, y <span class="op">=</span> <span class="va">Effect_Est</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">CI_Lower</span>, ymax <span class="op">=</span> <span class="va">CI_Upper</span><span class="op">)</span>,</span>
<span>              fill <span class="op">=</span> <span class="st">"blue"</span>, alpha <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, linetype <span class="op">=</span> <span class="st">"dotted"</span>, color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">gst_stop</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">dirichlet_stop</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span>, color <span class="op">=</span> <span class="st">"green"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">1376</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span>, color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span><span class="st">"text"</span>, x <span class="op">=</span> <span class="va">gst_stop</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">Effect_Est</span><span class="op">)</span>,</span>
<span>           label <span class="op">=</span> <span class="st">"GST Stop"</span>, color <span class="op">=</span> <span class="st">"red"</span>, vjust <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, hjust <span class="op">=</span> <span class="fl">1.2</span>, size <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span><span class="st">"text"</span>, x <span class="op">=</span> <span class="va">dirichlet_stop</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">Effect_Est</span><span class="op">)</span>,</span>
<span>           label <span class="op">=</span> <span class="st">"Dirichlet Stop"</span>, color <span class="op">=</span> <span class="st">"green"</span>, vjust <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, hjust <span class="op">=</span> <span class="fl">0</span>, size <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span><span class="st">"text"</span>, x <span class="op">=</span> <span class="fl">1376</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">Effect_Est</span><span class="op">)</span>,</span>
<span>           label <span class="op">=</span> <span class="st">"Original Stop"</span>, color <span class="op">=</span> <span class="st">"black"</span>, vjust <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, hjust <span class="op">=</span> <span class="fl">0</span>, size <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Illustration of Early Stopping"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"Simulation: pA=0.30, pB=0.35, alpha=0.05"</span>,</span>
<span>    x <span class="op">=</span> <span class="st">"Sample Size"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Estimated Log Click Rate Difference"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html">ggsave</a></span><span class="op">(</span><span class="st">"illustration_early_stopping.png"</span>, width <span class="op">=</span> <span class="fl">7</span>, height <span class="op">=</span> <span class="fl">6</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="illustration-of-mitigating-false-positives" class="level2"><h2 class="anchored" data-anchor-id="illustration-of-mitigating-false-positives">Illustration of Mitigating False Positives</h2>
<p>Sequential testing not only improves efficiency by enabling early stopping when a true effect exists, but it also helps mitigate false positives. To evaluate how different methods control false positive rates, I conducted another simulation under the same user clicking behavior setting—this time assuming no true effect. The goal is to track how false positive rates change as the number of peeks increases.</p>
<p>In addition to Group Sequential Testing (GST) and Distribution-Based Testing, I compare their performance against Naive Peeking, where a standard hypothesis test (e.g., a two-proportion z-test) is applied at each interim analysis without any correction for multiple looks.</p>
<p>As presented in the graph below, Naive Peeking quickly inflates false positives beyond 0.05, worsening as more peeks occur. In contrast, both GST and Distribution-Based Testing effectively control Type I error, keeping false positives at or below 0.05. Distribution-Based Testing provides even tighter error control, ensuring anytime-valid inference while allowing continuous monitoring.</p>
<p><img src="false_positive_comparison.png" class="img-fluid"></p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">naive_test</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">counts</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">A_clicks</span> <span class="op">&lt;-</span> <span class="va">counts</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="va">B_clicks</span> <span class="op">&lt;-</span> <span class="va">counts</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span>  <span class="va">total_clicks</span> <span class="op">&lt;-</span> <span class="va">A_clicks</span> <span class="op">+</span> <span class="va">B_clicks</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">total_clicks</span> <span class="op">&lt;</span> <span class="fl">2</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">pA</span> <span class="op">&lt;-</span> <span class="va">A_clicks</span> <span class="op">/</span> <span class="va">total_clicks</span></span>
<span>  <span class="va">pB</span> <span class="op">&lt;-</span> <span class="va">B_clicks</span> <span class="op">/</span> <span class="va">total_clicks</span></span>
<span>  <span class="va">p_hat</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">A_clicks</span> <span class="op">+</span> <span class="va">B_clicks</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">total_clicks</span> <span class="op">+</span> <span class="va">total_clicks</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">z_num</span> <span class="op">&lt;-</span> <span class="va">pA</span> <span class="op">-</span> <span class="va">pB</span></span>
<span>  <span class="va">z_den</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">p_hat</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">p_hat</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="va">total_clicks</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="va">total_clicks</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">z_den</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">z_stat</span> <span class="op">&lt;-</span> <span class="va">z_num</span> <span class="op">/</span> <span class="va">z_den</span></span>
<span>  <span class="va">p_val</span> <span class="op">&lt;-</span> <span class="fl">2</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">pnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">z_stat</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="op">(</span><span class="va">p_val</span> <span class="op">&lt;</span> <span class="fl">0.05</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">simulate_one_run</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n_users</span> <span class="op">=</span> <span class="fl">2000</span>, <span class="va">num_peeks</span> <span class="op">=</span> <span class="fl">10</span>, <span class="va">alpha</span> <span class="op">=</span> <span class="fl">0.05</span>, <span class="va">pA</span> <span class="op">=</span> <span class="fl">0.3</span>, <span class="va">pB</span> <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">generate_click_data</span><span class="op">(</span><span class="va">n_users</span>, <span class="va">pA</span>, <span class="va">pB</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">step</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">floor</a></span><span class="op">(</span><span class="va">n_users</span> <span class="op">/</span> <span class="va">num_peeks</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">step</span> <span class="op">&lt;</span> <span class="fl">1</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"num_peeks too large for n_users"</span><span class="op">)</span></span>
<span>  <span class="va">peeking_points</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="va">step</span>, <span class="va">n_users</span>, by <span class="op">=</span> <span class="va">step</span><span class="op">)</span></span>
<span>  <span class="va">total_checks</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">peeking_points</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">reject_dirichlet</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span></span>
<span>  <span class="va">reject_pocock</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span></span>
<span>  <span class="va">reject_naive</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span></span>
<span>  </span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_users</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">counts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">A_clicks</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="va">df</span><span class="op">$</span><span class="va">B_clicks</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">reject_dirichlet</span> <span class="op">&amp;&amp;</span> <span class="fu">sequential_p_value</span><span class="op">(</span><span class="va">counts</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">0.5</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="va">alpha</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">reject_dirichlet</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="va">peeking_points</span> <span class="op">==</span> <span class="va">i</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="op">!</span><span class="va">reject_pocock</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">peeking_points</span> <span class="op">==</span> <span class="va">i</span><span class="op">)</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="fu">gst_test</span><span class="op">(</span><span class="va">counts</span>, <span class="va">idx</span>, <span class="va">total_checks</span>, <span class="va">alpha</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">reject_pocock</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="va">peeking_points</span> <span class="op">==</span> <span class="va">i</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="op">!</span><span class="va">reject_naive</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="fu">naive_test</span><span class="op">(</span><span class="va">counts</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">reject_naive</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">reject_dirichlet</span> <span class="op">&amp;&amp;</span> <span class="va">reject_pocock</span> <span class="op">&amp;&amp;</span> <span class="va">reject_naive</span><span class="op">)</span> <span class="kw">break</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>    dirichlet <span class="op">=</span> <span class="va">reject_dirichlet</span>,</span>
<span>    pocock <span class="op">=</span> <span class="va">reject_pocock</span>,</span>
<span>    naive <span class="op">=</span> <span class="va">reject_naive</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">num_peeks_vec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">10</span>, <span class="fl">2</span><span class="op">)</span> </span>
<span><span class="va">n_sims</span> <span class="op">&lt;-</span> <span class="fl">500</span>                   </span>
<span><span class="va">n_users</span> <span class="op">&lt;-</span> <span class="fl">2000</span>                </span>
<span><span class="va">alpha</span> <span class="op">&lt;-</span> <span class="fl">0.05</span>                </span>
<span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>num_peeks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">integer</a></span><span class="op">(</span><span class="op">)</span>, method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">character</a></span><span class="op">(</span><span class="op">)</span>, fp_rate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">np</span> <span class="kw">in</span> <span class="va">num_peeks_vec</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">rejections</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">replicate</a></span><span class="op">(</span><span class="va">n_sims</span>, <span class="op">{</span></span>
<span>    <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu">simulate_one_run</span><span class="op">(</span>num_peeks <span class="op">=</span> <span class="va">np</span>, alpha <span class="op">=</span> <span class="va">alpha</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>dirichlet <span class="op">=</span> <span class="va">res</span><span class="op">$</span><span class="va">dirichlet</span>, pocock <span class="op">=</span> <span class="va">res</span><span class="op">$</span><span class="va">pocock</span>, naive <span class="op">=</span> <span class="va">res</span><span class="op">$</span><span class="va">naive</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">rejections</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">rejections</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">fp_rates</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colMeans</a></span><span class="op">(</span><span class="va">rejections</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span></span>
<span>    <span class="va">results</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>num_peeks <span class="op">=</span> <span class="va">np</span>, method <span class="op">=</span> <span class="st">"Dirichlet"</span>, fp_rate <span class="op">=</span> <span class="va">fp_rates</span><span class="op">[</span><span class="st">"dirichlet"</span><span class="op">]</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>num_peeks <span class="op">=</span> <span class="va">np</span>, method <span class="op">=</span> <span class="st">"GST"</span>, fp_rate <span class="op">=</span> <span class="va">fp_rates</span><span class="op">[</span><span class="st">"pocock"</span><span class="op">]</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>num_peeks <span class="op">=</span> <span class="va">np</span>, method <span class="op">=</span> <span class="st">"Naive Peek"</span>, fp_rate <span class="op">=</span> <span class="va">fp_rates</span><span class="op">[</span><span class="st">"naive"</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">results</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">num_peeks</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">fp_rate</span>,</span>
<span>                color <span class="op">=</span> <span class="va">method</span>, group <span class="op">=</span> <span class="va">method</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0.05</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Comparison of False Positive Rates"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"Simulation: No Effect, Count Data"</span>,</span>
<span>    x <span class="op">=</span> <span class="st">"Number of Peeks"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"False Positive Rate"</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"Method"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html">ggsave</a></span><span class="op">(</span><span class="st">"false_positive_comparison.png"</span>, width <span class="op">=</span> <span class="fl">7</span>, height <span class="op">=</span> <span class="fl">6</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section></section><section id="summary" class="level1"><h1>Summary</h1>
<p>As we have seen, sequential testing strikes a balance between efficiency and accuracy, enabling faster effect detection while controlling false positives. Among these methods, distribution-based testing offers the most flexibility, without the need for assumptions about distribution shape, predefined interim checks, or alpha-spending functions.</p>
<p><strong>References:</strong></p>
<p>Netflix Technology Blog. 2019. Improving Experimentation Efficiency at Netflix with Meta Analysis and Optimal Stopping [<a href="https://netflixtechblog.com/improving-experimentation-efficiency-at-netflix-with-meta-analysis-and-optimal-stopping-d8ec290ae5be">link</a>]</p>
<p>Aaditya Ramdas. 2019. “Foundations of Large-Scale”Doubly-Sequential” Experimentation” [<a href="https://www.stat.cmu.edu/~aramdas/kdd19/ramdas-kdd-tut.pdf">link</a>]</p>
<p>Netflix Technology Blog. 2024. Sequential A/B Testing Keeps the World Streaming Netflix Part 1: Continuous Data [<a href="https://netflixtechblog.com/sequential-a-b-testing-keeps-the-world-streaming-netflix-part-1-continuous-data-cba6c7ed49df">link</a>]</p>
<p>Netflix Technology Blog. 2024. Sequential A/B Testing Keeps the World Streaming Netflix Part 2: Counting Processes [<a href="https://netflixtechblog.com/sequential-testing-keeps-the-world-streaming-netflix-part-2-counting-processes-da6805341642">link</a>]</p>


</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>